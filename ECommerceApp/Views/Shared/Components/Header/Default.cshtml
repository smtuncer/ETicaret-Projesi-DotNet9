@using ECommerceApp.Models
@model IEnumerable<Category>

<header class="header header--standard header--market-place-2" data-sticky="true">
    <div class="header__top">
        <div class="container">
            <div class="header__left">
                <p>Online Alışveriş Mağazamıza Hoş Geldiniz!</p>
            </div>
            <div class="header__right">
                <ul class="header__top-links">
                    <li><a asp-area="User" asp-controller="Home" asp-action="OrderTracking">Siparişimi Takip Et</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="header__content">
        <div class="container">
            <div class="header__content-left">
                <a class="ps-logo" href="/"><img src="~/luxda-logo.png" alt="Logo" style="max-width:120px;"></a>
                <div class="menu--product-categories">
                    <div class="menu__toggle"><i class="icon-menu"></i></div>
                    <div class="menu__content">
                        <ul class="menu--dropdown">
                            @if (Model != null && Model.Any())
                            {
                                foreach (var category in Model)
                                {
                                    var viewData = new ViewDataDictionary(ViewData);
                                    viewData["IsRoot"] = true;
                                    <partial name="_HeaderVerticalCategoryItem" model="category" view-data="viewData" />
                                }
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="header__content-center">
                <form class="ps-form--quick-search" asp-area="User" asp-controller="Product" asp-action="Index" method="get">
                    <div class="search-autocomplete-wrapper" style="position: relative;">
                        <input class="form-control" type="text" name="search" id="header-search-input" placeholder="Ürün ara..." autocomplete="off">
                        <button type="submit">Ara</button>
                        <div id="search-results" class="search-autocomplete-results" style="display: none;"></div>
                    </div>
                </form>
            </div>
            <div class="header__content-right">
                <div class="header__actions">
                    <div class="ps-cart--mini">
                        <a class="header__extra" href="javascript:void(0);"><i class="icon-bag2"></i><span id="cart-count"><i>0</i></span></a>
                        <div class="ps-cart__content" id="cart-preview-container">
                            <!-- Cart content will be loaded here -->
                            <div class="ps-cart__items">
                                <p class="text-center py-3">Yükleniyor...</p>
                            </div>
                        </div>
                    </div>
                    <div class="ps-block--user-header">
                        <div class="ps-block__left"><i class="icon-user"></i></div>
                        @if (User.Identity.IsAuthenticated)
                        {
                            <div class="ps-block__right"><a asp-controller="Identity" asp-action="Index">@User.Identity.Name</a><a href="/cikis">Çıkış Yap</a></div>
                        }
                        else
                        {
                            <div class="ps-block__right"><a href="/giris">Giriş Yap</a><a href="/giris">Kayıt Ol</a></div>
                        }
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
    <nav class="navigation bg-brand text-on-brand">
        <div class="container">
            <ul class="menu menu--market-2">
                <li><a href="/">Anasayfa</a></li>
                @if (Model != null && Model.Any())
                {
                    foreach (var category in Model)
                    {
                        if (!category.ShowInMenu) continue;
                        <partial name="_CategoryMenuItem" model="category" />
                    }
                }
            </ul>
        </div>
    </nav>
</header>
<header class="header header--mobile" data-sticky="true">
    <div class="navigation--mobile">
        <div class="navigation__left"><a class="ps-logo" href="/"><img src="~/luxda-logo.png" alt="Logo" style="max-width:140px;" /></a></div>
        <div class="navigation__right">
            <div class="header__actions">
                <div class="ps-block--user-header">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="ps-block__left"><a asp-controller="Identity" asp-action="Index"><i class="icon-user"></i></a></div>
                        <div class="ps-block__right"><a asp-controller="Identity" asp-action="Index">@User.Identity.Name</a><a href="/cikis">Çıkış Yap</a></div>
                    }
                    else
                    {
                        <div class="ps-block__right"><a href="/giris">Giriş Yap</a><a href="/kayit-ol">Kayıt Ol</a></div>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="ps-search--mobile">
        <form class="ps-form--search-mobile" asp-area="User" asp-controller="Product" asp-action="Index" method="get">
            <div class="form-group--nest" style="position: relative;">
                <input class="form-control" type="text" name="search" id="mobile-search-input" placeholder="Ürün ara..." autocomplete="off" />
                <button type="submit"><i class="icon-magnifier"></i></button>
                <div id="mobile-search-results" class="search-autocomplete-results" style="display: none;"></div>
            </div>
        </form>
    </div>
</header>

<!-- Mobile Bottom Navigation -->
<div class="mobile-bottom-nav">
    <a href="/" class="mobile-bottom-nav__item">
        <i class="icon-home"></i>
        <span>Anasayfa</span>
    </a>
    <a href="#menu-mobile" class="mobile-bottom-nav__item ps-toggle--sidebar">
        <i class="icon-list"></i>
        <span>Kategoriler</span>
    </a>
    <a href="#mobile-search" class="mobile-bottom-nav__item ps-toggle--sidebar">
        <i class="icon-magnifier"></i>
        <span>Ara</span>
    </a>
    <a href="#cart-mobile" class="mobile-bottom-nav__item mobile-bottom-nav__item--cart ps-toggle--sidebar">
        <i class="icon-bag2"></i>
        <span class="mobile-bottom-nav__badge" id="mobile-bottom-cart-count">0</span>
        <span>Sepet</span>
    </a>
</div>

<div class="ps-panel--sidebar" id="cart-mobile">
    <div class="ps-panel__header">
        <h3>Sepetim</h3>
        <a class="ps-panel__close" href="#cart-mobile"><i class="icon-cross"></i></a>
    </div>
    <div class="navigation__content">
        <div class="ps-cart--mobile">
            <div class="ps-cart__content" id="cart-preview-container-sidebar">
                <div class="ps-cart__items">
                    <p class="text-center py-3">Yükleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="ps-panel--sidebar" id="mobile-search">
    <div class="ps-panel__header">
        <form class="ps-form--search-mobile" asp-area="User" asp-controller="Product" asp-action="Index" method="get">
            <div class="form-group--nest">
                <input class="form-control" type="text" name="search" placeholder="Ürün ara...">
                <button><i class="icon-magnifier"></i></button>
            </div>
        </form>
        <a class="ps-panel__close" href="#mobile-search" style="margin-left: 10px;"><i class="icon-cross"></i></a>
    </div>
    <div class="navigation__content"></div>
</div>

<div class="ps-panel--sidebar" id="menu-mobile">
    <div class="ps-panel__header">
        <h3>Kategoriler</h3>
        <a class="ps-panel__close" href="#menu-mobile"><i class="icon-cross"></i></a>
    </div>
    <div class="ps-panel__content">
        <ul class="menu--mobile">
            @if (Model != null && Model.Any())
            {
                foreach (var category in Model)
                {
                    <partial name="_MobileMenuCategoryItem" model="category" />
                }
            }
        </ul>
    </div>
</div>
<!-- ... existing styles ... -->
<script>
    // ... existing search scripts ...

    // Generic Mobile Panel Close Handler
    document.addEventListener('DOMContentLoaded', function() {
        // Select all close buttons inside sidebars
        var closeBtns = document.querySelectorAll('.ps-panel--sidebar .ps-panel__close');
        var overlay = document.querySelector('.ps-site-overlay');

        closeBtns.forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                // Find the parent sidebar
                var sidebar = btn.closest('.ps-panel--sidebar');
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
                if (overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
        
        // Ensure overlay click closes all sidebars
        if (overlay) {
            overlay.addEventListener('click', function() {
                document.querySelectorAll('.ps-panel--sidebar').forEach(function(sidebar) {
                    sidebar.classList.remove('active');
                });
                overlay.classList.remove('active');
            });
        }
    });
</script>

<style>
    /* Search wrapper to keep input and button side by side */
    .search-autocomplete-wrapper {
        position: relative;
        display: flex;
        align-items: stretch; /* Changed from center to stretch for equal height */
        width: 100%;
    }

    .search-autocomplete-wrapper .form-control {
        flex: 1;
        border-top-right-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        margin: 0; /* Remove any margin */
    }

    .search-autocomplete-wrapper button {
        border-top-left-radius: 0 !important;
        border-bottom-left-radius: 0 !important;
        white-space: nowrap;
        margin: 0; /* Remove any margin */
        height: auto; /* Match input height */
        display: flex;
        align-items: center;
        padding: 0.375rem 1.5rem; /* Match input padding */
    }

    .search-autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #eee;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: -1px;
    }

    .search-result-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        color: #333;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .search-result-info {
        flex: 1;
        min-width: 0;
    }

    .search-result-name {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-result-brand {
        font-size: 12px;
        color: #999;
    }

    .search-result-price {
        font-size: 14px;
        font-weight: 600;
        color: #C5A059;
        white-space: nowrap;
    }

    .search-no-results {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }

    .search-loading {
        padding: 20px;
        text-align: center;
        color: #999;
        font-size: 14px;
    }
</style>

<style>
    /* Strict 3-Column Header Layout */
    .header__content > .container {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        flex-wrap: nowrap !important;
        gap: 40px !important; /* Explicit gap between the 3 main columns */
        position: relative;
    }

    /* 1. Left Section: Logo + Category Menu */
    .header__content-left {
        flex: 0 0 auto !important;
        display: flex !important;
        align-items: center !important;
        gap: 20px; /* Space between Logo and Category Toggle */
        margin: 0 !important;
        width: auto !important;
    }
    
    .ps-logo {
        margin-right: 0 !important;
        flex-shrink: 0;
    }
    
    .menu--product-categories {
        margin: 0 !important;
        flex-shrink: 0;
        display: block !important;
    }
    
    /* 2. Center Section: Search Bar */
    .header__content-center {
        flex: 1 1 auto !important; /* Fill remaining space */
        min-width: 250px; /* Minimum width before breaking */
        margin: 0 !important;
        position: relative;
        z-index: 20;
    }
    
    .ps-form--quick-search {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
    }

    /* 3. Right Section: Cart + Profile */
    .header__content-right {
        display: flex !important;
        align-items: center !important;
        justify-content: flex-end !important;
        margin: 0 !important;
        gap: 25px; /* Space between Cart and Profile */
        position: relative;
        z-index: 30; /* Ensure on top */
    }

    .header__actions {
        display: flex !important;
        align-items: center !important;
        justify-content: flex-end !important;
        width: auto !important;
        gap: 25px;
    }

    /* Cart Icon Area */
    .ps-cart--mini {
        margin: 0 !important;
        position: relative;
        display: flex !important;
        align-items: center;
        flex-shrink: 0;
    }

    /* User Profile Area */
    .ps-block--user-header {
        display: flex !important;
        align-items: center !important;
        margin: 0 !important;
        gap: 10px;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .ps-block--user-header .ps-block__right {
        display: flex;
        flex-direction: column;
        line-height: normal;
        text-align: left;
    }
    
    .ps-block--user-header .ps-block__right a {
        display: block;
        font-size: 13px;
    }

    /* Mobile Menu Accordion Styles - Force Overrides */
    #menu-mobile .menu--mobile li {
        position: relative;
        display: block;
        width: 100%;
    }
    
    #menu-mobile .menu--mobile .sub-menu {
        display: none; /* Hidden by default, toggled by JS */
        position: static !important; /* Force flow layout, no absolute/flyout */
        width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        opacity: 1 !important;
        visibility: visible !important;
        transform: none !important;
        padding-left: 20px; /* Indent sub-items */
        background-color: #f8f9fa; /* Slight background distinction */
    }

    #menu-mobile .menu--mobile .sub-toggle {
        position: absolute;
        top: 0;
        right: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        background: transparent;
    }

    /* Style the toggle icon - Force Plus Sign */
    #menu-mobile .menu--mobile .sub-toggle::before {
        display: none !important; /* Hide any default theme arrow */
    }

    #menu-mobile .menu--mobile .sub-toggle::after {
        content: '+'; /* Simple Plus sign as requested */
        font-family: 'Work Sans', sans-serif; /* Use standard font for grid text or specific icon font if preferred */
        font-size: 20px;
        font-weight: 400;
    }
    
    /* When active (toggled open) change to Minus or keep Plus? User didn't specify, but rotation usually implies X or change. 
       Let's just keep it simple or rotate it. */
    #menu-mobile .menu--mobile .sub-toggle.active {
        transform: rotate(45deg); /* Plus becomes X when open */
    }

    /* Fix for Nested Sub-Categories in Header Vertical Menu (Mega Menu) */
    .menu--product-categories .mega-menu {
        overflow: visible !important; /* Allow sub-menus to fly out */
    }

    .menu--product-categories .mega-menu__list {
        position: relative;
    }

    .menu--product-categories .mega-menu__list li.menu-item-has-children {
        position: relative; /* Anchor for the sub-menu */
    }

    .menu--product-categories .mega-menu__list li.menu-item-has-children:hover > .sub-menu {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        position: absolute;
        left: 100%;
        top: 0;
        width: 250px; /* Standard width */
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 15px 0;
        z-index: 1000;
        border: 1px solid #eaeaea;
    }

    /* Ensure sub-menu items are styled correctly */
    .menu--product-categories .mega-menu__list li.menu-item-has-children > .sub-menu > li > a {
        padding: 10px 20px;
        display: block;
        color: #555;
        font-size: 14px;
        line-height: 20px;
    }

    .menu--product-categories .mega-menu__list li.menu-item-has-children > .sub-menu > li > a:hover {
        color: #fcb800; /* Theme accent color */
    }
</style>

<script>
    // Slug generation function (matches server-side FriendlyURLTitle)
    function generateSlug(text) {
        if (!text) return '';
        
        return text
            .toLowerCase()
            .replace(/ş/g, 's')
            .replace(/ğ/g, 'g')
            .replace(/ü/g, 'u')
            .replace(/ı/g, 'i')
            .replace(/ö/g, 'o')
            .replace(/ç/g, 'c')
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
    }

    // Desktop Search Autocomplete
    (function() {
        const searchInput = document.getElementById('header-search-input');
        const searchResults = document.getElementById('search-results');
        let searchTimeout;

        if (!searchInput || !searchResults) return;

        searchInput.addEventListener('input', function() {
            const term = this.value.trim();

            clearTimeout(searchTimeout);

            if (term.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            searchResults.innerHTML = '<div class="search-loading">Aranıyor...</div>';
            searchResults.style.display = 'block';

            searchTimeout = setTimeout(function() {
                fetch(`/api/products/search?term=${encodeURIComponent(term)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            let html = '';
                            data.results.forEach(product => {
                                // Use slug if available, otherwise generate from name
                                const slug = product.slug || generateSlug(product.name);
                                const productUrl = `/urun/${slug}-${product.id}`;
                                
                                html += `
                                    <a href="${productUrl}" class="search-result-item">
                                        <img src="${product.image}" alt="${product.name}" class="search-result-image">
                                        <div class="search-result-info">
                                            <div class="search-result-name">${product.name}</div>
                                            ${product.brand ? `<div class="search-result-brand">${product.brand}</div>` : ''}
                                        </div>
                                        <div class="search-result-price">${product.price.toFixed(2)} ₺</div>
                                    </a>
                                `;
                            });
                            searchResults.innerHTML = html;
                        } else {
                            searchResults.innerHTML = '<div class="search-no-results">Ürün bulunamadı</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Arama hatası:', error);
                        searchResults.innerHTML = '<div class="search-no-results">Bir hata oluştu</div>';
                    });
            }, 300);
        });

        // Click outside to close
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Show results when input is focused and has value
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2 && searchResults.innerHTML) {
                searchResults.style.display = 'block';
            }
        });
    })();

    // Mobile Search Autocomplete
    (function() {
        const mobileSearchInput = document.getElementById('mobile-search-input');
        const mobileSearchResults = document.getElementById('mobile-search-results');
        let mobileSearchTimeout;

        if (!mobileSearchInput || !mobileSearchResults) return;

        mobileSearchInput.addEventListener('input', function() {
            const term = this.value.trim();

            clearTimeout(mobileSearchTimeout);

            if (term.length < 2) {
                mobileSearchResults.style.display = 'none';
                return;
            }

            mobileSearchResults.innerHTML = '<div class="search-loading">Aranıyor...</div>';
            mobileSearchResults.style.display = 'block';

            mobileSearchTimeout = setTimeout(function() {
                fetch(`/api/products/search?term=${encodeURIComponent(term)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            let html = '';
                            data.results.forEach(product => {
                                // Use slug if available, otherwise generate from name
                                const slug = product.slug || generateSlug(product.name);
                                const productUrl = `/urun/${slug}-${product.id}`;
                                
                                html += `
                                    <a href="${productUrl}" class="search-result-item">
                                        <img src="${product.image}" alt="${product.name}" class="search-result-image">
                                        <div class="search-result-info">
                                            <div class="search-result-name">${product.name}</div>
                                            ${product.brand ? `<div class="search-result-brand">${product.brand}</div>` : ''}
                                        </div>
                                        <div class="search-result-price">${product.price.toFixed(2)} ₺</div>
                                    </a>
                                `;
                            });
                            mobileSearchResults.innerHTML = html;
                        } else {
                            mobileSearchResults.innerHTML = '<div class="search-no-results">Ürün bulunamadı</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Arama hatası:', error);
                        mobileSearchResults.innerHTML = '<div class="search-no-results">Bir hata oluştu</div>';
                    });
            }, 300);
        });

        // Click outside to close
        document.addEventListener('click', function(e) {
            if (!mobileSearchInput.contains(e.target) && !mobileSearchResults.contains(e.target)) {
                mobileSearchResults.style.display = 'none';
            }
        });

        // Show results when input is focused and has value
        mobileSearchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2 && mobileSearchResults.innerHTML) {
                mobileSearchResults.style.display = 'block';
            }
        });
    })();

    // Mobile Menu Close Handler
    document.addEventListener('DOMContentLoaded', function() {
        var closeBtn = document.querySelector('#menu-mobile .ps-panel__close');
        var mobileMenu = document.getElementById('menu-mobile');
        var overlay = document.querySelector('.ps-site-overlay');

        if (closeBtn && mobileMenu) {
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                mobileMenu.classList.remove('active');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            });
        }
    });
</script>
