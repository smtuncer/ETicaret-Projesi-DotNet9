@model IEnumerable<ECommerceApp.Models.Product>

@{
    ViewData["Title"] = "Ürünler";
    Layout = "~/Areas/Admin/Views/_AdminLayout.cshtml";
}

<div class="app-main flex-column flex-row-fluid" id="kt_app_main">
    <div class="d-flex flex-column flex-column-fluid">
        <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
            <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
                <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                    <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">Ürünler</h1>
                    <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                        <li class="breadcrumb-item text-muted">
                            <a asp-controller="Dashboard" asp-action="Index" class="text-muted text-hover-primary">Dashboard</a>
                        </li>
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-500 w-5px h-2px"></span>
                        </li>
                        <li class="breadcrumb-item text-muted">Ürünler</li>
                    </ul>
                </div>
                <div class="card-toolbar">
                    <a asp-action="Create" class="btn btn-sm btn-primary">
                        <i class="ki-duotone ki-plus fs-2"></i>Yeni Ürün
                    </a>
                </div>
            </div>
        </div>
        <div id="kt_app_content" class="app-content flex-column-fluid">
            <div id="kt_app_content_container" class="app-container container-xxl">
                <!-- Search and Filter -->
                <div class="card mb-5">
                    <div class="card-body">
                        @{
                            bool? selectedFeatured = ViewBag.IsFeatured != null ? (bool?)ViewBag.IsFeatured : null;
                        }
                        <form method="get" asp-action="Index" class="row g-3">
                            <div class="col-md-3">
                                <input type="text" name="search" value="@ViewBag.Search" class="form-control" placeholder="Ürün adı, SKU veya Barkod...">
                            </div>
                            <div class="col-md-3">
                                <select name="categoryId" class="form-select">
                                    <option value="">Tüm Kategoriler</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <option value="@category.Id" selected="@(ViewBag.CategoryId == category.Id)">@category.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="brandId" class="form-select">
                                    <option value="">Tüm Markalar</option>
                                    @if (ViewBag.Brands != null)
                                    {
                                        @foreach (var brand in ViewBag.Brands)
                                        {
                                            <option value="@brand.Id" selected="@(ViewBag.BrandId == brand.Id)">@brand.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="isFeatured" class="form-select">
                                    @if (selectedFeatured == null)
                                    {
                                        <option value="" selected="selected">Öne Çıkarılma: Tümü</option>
                                    }
                                    else
                                    {
                                        <option value="">Öne Çıkarılma: Tümü</option>
                                    }

                                    @if (selectedFeatured == true)
                                    {
                                        <option value="true" selected="selected">Sadece Öne Çıkarılanlar</option>
                                    }
                                    else
                                    {
                                        <option value="true">Sadece Öne Çıkarılanlar</option>
                                    }

                                    @if (selectedFeatured == false)
                                    {
                                        <option value="false" selected="selected">Öne Çıkarılmayanlar</option>
                                    }
                                    else
                                    {
                                        <option value="false">Öne Çıkarılmayanlar</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-12 d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="ki-duotone ki-magnifier fs-2"></i>Ara
                                    </button>
                                    <a asp-action="Index" class="btn btn-light">Temizle</a>
                                </div>
                            </div>
                        </form>
                        
                        <!-- XML Import Section -->
                        <div class="separator separator-dashed my-5"></div>
                        <div>
                            <div>
                                <h5 class="mb-1">XML Veri Aktarımı</h5>
                                <p class="text-muted fs-7 mb-0">
                                    <i class="ki-duotone ki-information-5 fs-5 text-primary me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                    Kaynak 1: <code class="text-primary">http://xml.ebijuteri.com/api/xml/601b9ef80766d6212a27da02?format=old</code>
                                    <br />
                                    <i class="ki-duotone ki-information-5 fs-5 text-primary me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                    Kaynak 2: <code class="text-primary">https://cdn1.xmlbankasi.com/p1/pjsymndiclkn/image/data/xml/urunler1.xml</code>
                                    <br />
                                    <i class="ki-duotone ki-information-5 fs-5 text-primary me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                    Kaynak 3: <code class="text-primary">https://www.yntithalat.com/export/26f8870d6d673ff4f4eafafc408aec061h11AIIriSMyB7kFg==</code>
                                </p>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <a asp-action="ExportExcel" class="btn btn-success">
                                    <i class="ki-duotone ki-file-down fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Excel İndir
                                </a>
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#excelImportModal">
                                    <i class="ki-duotone ki-file-up fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Excel Yükle
                                </button>
                                <button type="button" class="btn btn-info btn-xml-import" data-source="ebijuteri">
                                    <i class="ki-duotone ki-cloud-download fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Ebijuteri'den Getir
                                </button>
                                <button type="button" class="btn btn-primary btn-xml-import" data-source="xmlbankasi">
                                    <i class="ki-duotone ki-cloud-download fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    XmlBankasi'ndan Getir
                                </button>
                                <button type="button" class="btn btn-dark btn-xml-import" data-source="yntithalat">
                                    <i class="ki-duotone ki-cloud-download fs-2">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    Yntİthalat'tan Getir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

<!-- Excel Import Modal -->
<div class="modal fade" id="excelImportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Excel ile Ürün Yükle</h3>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1"></i>
                </div>
            </div>
            <form asp-action="ImportExcel" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-5">
                        <label class="form-label required">Excel Dosyası (.xlsx)</label>
                        <input type="file" name="excelFile" class="form-control" accept=".xlsx" required />
                        <div class="form-text text-muted">
                            Lütfen "Excel İndir" butonu ile aldığınız formatta bir dosya yükleyiniz.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Yükle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- XML Import Progress Modal -->
<div class="modal fade" id="xmlImportModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h3 class="modal-title">XML Veri Aktarımı</h3>
            </div>
            <div class="modal-body text-center py-10">
                <div class="mb-5">
                    <i class="ki-duotone ki-cloud-download fs-5x text-primary mb-5">
                        <span class="path1"></span>
                        <span class="path2"></span>
                    </i>
                </div>
                
                <h4 class="mb-3" id="importStatusText">Veriler aktarılıyor...</h4>
                <p class="text-muted mb-5" id="importDetailText">Lütfen bekleyiniz, bu işlem birkaç dakika sürebilir.</p>
                
                <!-- Progress Bar -->
                <div class="progress h-20px mb-5">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         role="progressbar" 
                         style="width: 100%" 
                         aria-valuenow="100" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                
                <!-- Spinner -->
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="xmlImportForm" asp-action="ImportXml" method="post" style="display:none;">
    <input type="hidden" name="source" id="xmlSource" />
</form>

<script>
    var importButtons = document.querySelectorAll('.btn-xml-import');
    importButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var source = this.getAttribute('data-source');
            document.getElementById('xmlSource').value = source;
            
            // Show modal
            var modal = new bootstrap.Modal(document.getElementById('xmlImportModal'));
            modal.show();
            
            // Submit form
            document.getElementById('xmlImportForm').submit();
        });
    });
</script>

                <div class="card mb-5 mb-xl-8">
                    <div class="card-header border-0 pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold fs-3 mb-1">Toplam @ViewBag.TotalItems Ürün</span>
                        </h3>
                    </div>
                    <div class="card-body py-3">
                        <div class="table-responsive">
                            <table class="table align-middle gs-0 gy-4">
                                <thead>
                                    <tr class="fw-bold text-muted bg-light">
                                        <th class="ps-4 rounded-start">Ürün Adı</th>
                                        <th>SKU</th>
                                        <th>Fiyat</th>
                                        <th>Stok</th>
                                        <th>Kategori</th>
                                        <th>Marka</th>
                                        <th>Öne Çıkarılsın</th>
                                        <th>Durum</th>
                                        <th class="rounded-end"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr>
                                            <td>
                                                <span class="text-dark fw-bold text-hover-primary mb-1 fs-6">@item.Name</span>
                                            </td>
                                            <td>
                                                <span class="text-muted fw-semibold d-block fs-7">@item.SKU</span>
                                            </td>
                                            <td>
                                                <span class="text-dark fw-bold d-block fs-7">@item.Price @item.Currency</span>
                                            </td>
                                            <td>
                                                @if (item.Stock > 0)
                                                {
                                                    <span class="badge badge-light-success">@item.Stock</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-light-danger">Stok Yok</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="text-muted fw-semibold d-block fs-7">@(item.Category?.Name ?? "-")</span>
                                            </td>
                                            <td>
                                                <span class="text-muted fw-semibold d-block fs-7">@(item.Brand?.Name ?? "-")</span>
                                            </td>
                                            <td>
                                                @if (item.IsFeatured)
                                                {
                                                    <span class="badge badge-light-primary">Evet</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-light-secondary">Hayır</span>
                                                }
                                            </td>
                                            <td>
                                                @if (item.IsActive)
                                                {
                                                    <span class="badge badge-light-success">Aktif</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-light-danger">Pasif</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-info btn-sm px-4 me-2">
                                                    <i class="bi bi-eye-fill"></i>
                                                </a>
                                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-success btn-sm px-4 me-2">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                                <button type="button" onclick="openDeleteModal(@item.Id)" class="btn btn-danger btn-sm px-4 me-2">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
@{
    int totalPages = ViewBag.TotalPages != null ? (int)ViewBag.TotalPages : 1;
    int currentPage = ViewBag.CurrentPage != null ? (int)ViewBag.CurrentPage : 1;
    int windowSize = 5;
    int startPage = Math.Max(1, currentPage - 2);
    int endPage = Math.Min(totalPages, startPage + windowSize - 1);
    if (endPage - startPage < windowSize - 1)
    {
        startPage = Math.Max(1, endPage - windowSize + 1);
    }
}

                        @if (totalPages > 1)
                        {
                            <div class="d-flex justify-content-between align-items-center mt-5">
                                <div class="text-muted">
                                    Sayfa @currentPage / @totalPages
                                </div>
                                <ul class="pagination">
                                    @if (currentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-action="Index" asp-route-page="@(currentPage - 1)" asp-route-search="@ViewBag.Search" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-isFeatured="@(ViewBag.IsFeatured)">Önceki</a>
                                        </li>
                                    }

                                    @if (startPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-action="Index" asp-route-page="1" asp-route-search="@ViewBag.Search" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-isFeatured="@(ViewBag.IsFeatured)">1</a>
                                        </li>
                                        @if (startPage > 2)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                    }

                                    @for (int i = startPage; i <= endPage; i++)
                                    {
                                        <li class="page-item @(i == currentPage ? "active" : "")">
                                            <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-search="@ViewBag.Search" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-isFeatured="@(ViewBag.IsFeatured)">@i</a>
                                        </li>
                                    }

                                    @if (endPage < totalPages)
                                    {
                                        if (endPage < totalPages - 1)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                        <li class="page-item">
                                            <a class="page-link" asp-action="Index" asp-route-page="@totalPages" asp-route-search="@ViewBag.Search" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-isFeatured="@(ViewBag.IsFeatured)">@totalPages</a>
                                        </li>
                                    }

                                    @if (currentPage < totalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" asp-action="Index" asp-route-page="@(currentPage + 1)" asp-route-search="@ViewBag.Search" asp-route-categoryId="@ViewBag.CategoryId" asp-route-brandId="@ViewBag.BrandId" asp-route-isFeatured="@(ViewBag.IsFeatured)">Sonraki</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered mw-650px">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="fw-bold">Ürün Sil</h2>
                <div class="btn btn-icon btn-sm btn-active-icon-primary" data-bs-dismiss="modal">
                    <i class="ki-duotone ki-cross fs-1"></i>
                </div>
            </div>
            <div class="modal-body scroll-y mx-5 mx-xl-15 my-7">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-warning fs-5x mb-5"></i>
                    <h3 class="fs-2 fw-bold mb-5">Emin misiniz?</h3>
                    <p class="text-gray-600 fs-5 mb-5">
                        Bu ürünü silmek istediğinize emin misiniz? Bu işlem geri alınamaz.
                    </p>
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">İptal</button>
                    <a id="btnDeleteConfirm" href="#" class="btn btn-danger">Evet, Sil</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openDeleteModal(id) {
        var modal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
        var btnConfirm = document.getElementById('btnDeleteConfirm');
        btnConfirm.href = '/Admin/Product/Delete/' + id;
        modal.show();
    }
</script>

@Html.AntiForgeryToken()

